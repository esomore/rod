{"version":3,"sources":["webpack:///./js/views/Store.js"],"names":["Store","followedUsers","Set","followers","cart","carts","state","items","id","class","k","user","e","stopPropagation","count","this","State","local","get","put","profilePhoto","chat","Session","channels","uuid","followable","isMyProfile","length","html","ProfilePhotoPicker","photo","src","onProfilePhotoSet","SafeImg","Identicon","Text","t","followedUserCount","followerCount","has","getPubKey","FollowButton","route","CopyButton","name","window","location","href","onAboutInput","about","renderItems","cartTotalItems","Object","keys","reduce","sum","props","store","noFollows","Filters","map","i","from","description","price","addToCart","renderUserStore","__html","OnboardingNotification","totalPrice","currentKey","item","parseInt","setState","prevProps","componentDidMount","sub","v","updateTotalPrice","p","a","eventListeners","o","public","on","args","onProduct","getCartFromUser","group","prevGroup","values","forEach","off","getProductsFromUser","getAllProducts","getAllCarts","View"],"mappings":"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","file":"9.chunk.dcf87.js","sourcesContent":["import { html } from 'htm/preact';\nimport {translate as t} from '../Translation';\nimport State from '../State';\nimport Session from '../Session';\nimport ProfilePhotoPicker from '../components/ProfilePhotoPicker';\nimport { route } from 'preact-router';\nimport SafeImg from '../components/SafeImg';\nimport Text from '../components/Text';\nimport Filters from '../components/Filters';\nimport CopyButton from '../components/CopyButton';\nimport FollowButton from '../components/FollowButton';\nimport Identicon from '../components/Identicon';\nimport View from './View';\nimport OnboardingNotification from \"../components/OnboardingNotification\";\n\nclass Store extends View {\n  constructor() {\n    super();\n    this.followedUsers = new Set();\n    this.followers = new Set();\n    this.cart = {};\n    this.carts = {};\n    this.state = {items:{}};\n    this.id = 'profile';\n    this.class = 'public-messages-view';\n  }\n\n  addToCart(k, user, e) {\n    e.stopPropagation();\n    const count = (this.cart[k + user] || 0) + 1;\n    State.local.get('cart').get(user).get(k).put(count);\n  }\n\n  renderUserStore(user) {\n    const chat = Session.channels[user];\n    const uuid = chat && chat.uuid;\n    const followable = !(this.isMyProfile || user.length < 40);\n    let profilePhoto;\n    if (this.isMyProfile) {\n      profilePhoto = html`<${ProfilePhotoPicker} currentPhoto=${this.state.photo} placeholder=${user} callback=${src => this.onProfilePhotoSet(src)}/>`;\n    } else if (this.state.photo) {\n        profilePhoto = html`<${SafeImg} class=\"profile-photo\" src=${this.state.photo}/>`\n    } else {\n      profilePhoto = html`<${Identicon} str=${user} width=250/>`\n    }\n    return html`\n      <div class=\"content\">\n        <div class=\"profile-top\">\n          <div class=\"profile-header\">\n            <div class=\"profile-photo-container\">\n              ${profilePhoto}\n            </div>\n            <div class=\"profile-header-stuff\">\n              <h3 class=\"profile-name\"><${Text} path= ${t('profile_name')} placeholder= ${t('name')} user=${user}/></h3>\n              <div class=\"profile-about hidden-xs\">\n                <p class=\"profile-about-content\">\n                  <${Text} path=\"store/about\" placeholder=${t('store_description')} attr=\"about\" user=${user}/>\n                </p>\n              </div>\n              <div class=\"profile-actions\">\n                <div class=\"follow-count\">\n                  <a href=\"/follows/${user}\">\n                    <span>${this.state.followedUserCount}</span> ${t('following')}\n                  </a>\n                  <a href=\"/followers/${user}\">\n                    <span>${this.state.followerCount}</span> ${t('followers')}\n                  </a>\n                </div>\n                ${this.followedUsers.has(Session.getPubKey()) ? html`\n                  <p><small>${t('follows_you')}</small></p>\n                `: ''}\n                ${followable ? html`<${FollowButton} id=${user}/>` : ''}\n                <button onClick=${() => route(`/chat/${  user}`)}>${t('send_message')}</button>\n                ${uuid ? '' : html`\n                  <${CopyButton} text=${t('copy_link')} title=${this.state.name} copyStr=${window.location.href}/>\n                `}\n              </div>\n            </div>\n          </div>\n          <div class=\"profile-about visible-xs-flex\">\n            <p class=\"profile-about-content\" placeholder=${this.isMyProfile ? t('about') : ''} contenteditable=${this.isMyProfile} onInput=${e => this.onAboutInput(e)}>${this.state.about}</p>\n          </div>\n        </div>\n\n        <h3>${t('store')}</h3>\n        ${this.renderItems()}\n      </div>\n    `;\n  }\n\n  renderItems() {\n    const cartTotalItems = Object.keys(this.cart).reduce((sum, k) => sum + this.cart[k], 0);\n    const keys = Object.keys(this.state.items);\n    return html`\n      ${(this.props.store || this.state.noFollows) ? '' : html`<${Filters}/>`}\n      ${cartTotalItems ? html`\n        <p>\n          <button onClick=${() => route('/checkout')}>${t('shopping_cart')}(${cartTotalItems})</button>\n        </p>\n      ` : ''}\n      <div class=\"thumbnail-items\">\n         ${this.isMyProfile ? html`\n          <div class=\"thumbnail-item store-item\" onClick=${() => route(`/product/new`)}>\n            <a href=\"/product/new\" class=\"name\">${t('add_item')}</a>\n          </div>\n        ` : ''}\n        ${!keys.length ? html`<p> ${t('no_items_to_show')}</p>`:''}\n        ${keys.map(k => {\n          const i = this.state.items[k];\n          return html`\n            <div class=\"thumbnail-item store-item\" onClick=${() => route(`/product/${k}/${i.from}`)}>\n              <${SafeImg} src=${i.photo || ''}/>\n              <a href=\"/product/${k}/${i.from || this.props.store}\" class=\"name\">${i.name}</a>\n              ${this.props.store ? '':html`\n                <small>by <${Text} path=\"profile/name\" editable=\"false\" placeholder=\"Name\" user=${i.from}/></small>\n              `}\n              <p class=\"description\">${i.description}</p>\n              <p class=\"price\">${i.price}</p>\n              <button class=\"add\" onClick=${e => this.addToCart(k, i.from, e)}>\n              ${t('add_to_cart')}\n                ${this.cart[k] ? ` (${this.cart[k]})` : ''}\n              </button>\n            </div>\n          `\n        })}\n      </div>\n    `;\n  }\n\n  renderView() {\n    if (this.props.store) {\n      return this.renderUserStore(this.props.store);\n    }\n    return html`\n      <p dangerouslySetInnerHTML=${{ __html: t('this_is_a_prototype_store', `href=\"/store/${Session.getPubKey()}\"`\n        )}}></p>\n      <${OnboardingNotification} />\n      ${this.renderItems()}\n    `;\n  }\n\n  updateTotalPrice() {\n    const totalPrice = Object.keys(this.cart).reduce((sum, currentKey) => {\n      const item = this.state.items[currentKey];\n      const price = item && parseInt(item.price) || 0;\n      return sum + price * this.cart[currentKey];\n    }, 0);\n    this.setState({totalPrice});\n  }\n\n  componentDidUpdate(prevProps) {\n    if (prevProps.store !== this.props.store) {\n      this.componentDidMount();\n    }\n  }\n\n  getCartFromUser(user) {\n    State.local.get('cart').get(user).map(this.sub(\n      (v, k) => {\n        if (k === '#') { return; } // blah\n        this.cart[k + user] = v;\n        this.carts[user] = this.carts[user] || {};\n        this.carts[user][k] = v;\n        this.setState({cart: this.cart, carts: this.carts});\n        this.updateTotalPrice();\n      }, `cart${  user}`\n    ));\n  }\n\n  onProduct(p, id, a, e, from) {\n    this.eventListeners[`products${  from}`] = e;\n    const items = this.state.items;\n    if (p && typeof p === \"object\") { // TODO gun returning bad data (typeof p === \"string\")?\n      const o = {};\n      p.from = from;\n      o[id] = p;\n      Object.assign(items, o);\n      this.updateTotalPrice();\n    } else {\n      delete items[id];\n    }\n    this.setState({items});\n  }\n\n  getProductsFromUser(user) {\n    State.public.user(user).get('store').get('products').map().on(this.sub(\n      (...args) => {\n        return this.onProduct(...args, user);\n      }, `${user  }products`\n    ));\n  }\n\n  getAllCarts() {\n    const carts = {};\n    State.local.get('cart').map(this.sub(\n      (o, user) => {\n        if (!user) {\n          delete carts[user];\n          return;\n        }\n        if (carts[user]) { return; }\n        carts[user] = true;\n        this.getCartFromUser(user);\n      }\n    ));\n  }\n\n  getAllProducts(group) {\n    State.group(group).map('store/products', this.sub(\n      (...args) => {\n        this.onProduct(...args);\n      }\n    ));\n  }\n\n  componentDidMount() {\n    const user = this.props.store;\n    Object.values(this.eventListeners).forEach(e => e.off());\n    this.cart = {};\n    this.isMyProfile = Session.getPubKey() === user;\n\n    if (user) {\n      this.getCartFromUser(user);\n      this.getProductsFromUser(user);\n    } else {\n      let prevGroup;\n      State.local.get('filters').get('group').on(this.sub(\n        group => {\n          if (group && group !== prevGroup) {\n            prevGroup = group;\n            this.getAllProducts(group);\n          }\n        }\n      ));\n      this.getAllCarts();\n    }\n  }\n}\n\nexport default Store;\n"],"sourceRoot":""}